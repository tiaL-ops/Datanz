<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Facility Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    form > div { margin-bottom: 1rem; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    input, select { width: 100%; padding: 0.5rem; box-sizing: border-box; }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; }
    th { background: #f0f0f0; }
    caption { text-align: left; font-size: 1.2rem; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>Filter Facilities</h1>

  <form method="get">
    <div>
      <label for="region">Region (starts with)</label>
      <input id="region" name="region" type="text" value="<%= filters.region || '' %>">
    </div>

    <div>
      <label for="waitThreshold">
        Long waits (show only if average wait &gt; 
        <input id="waitThreshold" name="waitThreshold" type="number" step="1" style="width:4rem;" value="<%= filters.waitThreshold %>"> minutes)
      </label>
    </div>

    <div>
      <label for="satThreshold">
        Low satisfaction (show only if average score &lt; 
        <input id="satThreshold" name="satThreshold" type="number" min="1" max="5" step="1" style="width:4rem;" value="<%= filters.satThreshold %>"> /5)
      </label>
    </div>

    <div>
      <label for="confiThreshold">
        Confidentiality concerns (show only if ≥ 
        <input id="confiThreshold" name="confiThreshold" type="number" step="1" style="width:4rem;" value="<%= filters.confiThreshold %>">% said “No”)
      </label>
    </div>

    <div>
      <label for="permThreshold">
        Permission issues (show only if ≥ 
        <input id="permThreshold" name="permThreshold" type="number" step="1" style="width:4rem;" value="<%= filters.permThreshold %>">% of patients were NOT asked)
      </label>
    </div>

    <div>
      <label for="testThreshold">
        Missing tests (show only if ≥ 
        <input id="testThreshold" name="testThreshold" type="number" step="1" style="width:4rem;" value="<%= filters.testThreshold %>">% did NOT get all tests)
      </label>
    </div>

    <div>
      <label for="medThreshold">
        Medicine gaps (show only if ≥ 
        <input id="medThreshold" name="medThreshold" type="number" step="1" style="width:4rem;" value="<%= filters.medThreshold %>">% got only some/none)
      </label>
    </div>

    <div>
      <label for="problemArea">
        Must mention problem area
        <input id="problemArea" name="problemArea" type="text" placeholder="e.g. long wait" value="<%= filters.problemArea || '' %>">
      </label>
    </div>

    <div>
      <label for="positiveArea">
        No positive feedback in area
        <input id="positiveArea" name="positiveArea" type="text" placeholder="e.g. cleanliness" value="<%= filters.positiveArea || '' %>">
      </label>
    </div>

    <div>
      <label for="paymentMode">Dominant payment type</label>
      <select id="paymentMode" name="paymentMode">
        <option value="">Any</option>
        <option value="Cash"      <%= filters.paymentMode==='Cash'?'selected':'' %>>Cash</option>
        <option value="Insurance" <%= filters.paymentMode==='Insurance'?'selected':'' %>>Insurance</option>
        <option value="Free"      <%= filters.paymentMode==='Free'?'selected':'' %>>Free</option>
      </select>
    </div>

    <button type="submit">Apply Filters</button>
  </form>

  <% if (results && results.length) { %>
    <table>
      <caption>Matching Facilities: <%= results.length %></caption>
      <thead>
        <tr>
          <th>Name</th>
          <th>Code</th>
          <th>Location</th>
          <th>Avg Wait (min)</th>
          <th>Avg Sat</th>
          <th>% No Privacy</th>
          <th>% No Permission</th>
          <th>% Missed Tests</th>
          <th>% Meds Gap</th>
          <th>Top Payment</th>
          <th>Top Problems</th>
          <th>Top Positives</th>
        </tr>
      </thead>
      <tbody>
        <% results.forEach(fac => {
             const m = fac.metrics;
        %>
        <tr>
          <td><%= fac.name %></td>
          <td><%= fac.code %></td>
          <td><%= fac.location %></td>
          <td><%= m.avgWait.toFixed(1) %></td>
          <td><%= m.avgSat %></td>
          <td><%= (100 - m.yesConfi).toFixed(0) %></td>
          <td><%= (100 - m.yesPerm).toFixed(0) %></td>
          <td><%= (100 - m.yesTests).toFixed(0) %></td>
          <td><%= (100 - m.yesMeds).toFixed(0) %></td>
          <td><%= m.topPayMode %></td>
          <td><%= m.topProblems.slice(0,3).join(", ") %></td>
          <td><%= m.topPositives.slice(0,3).join(", ") %></td>
        </tr>
        <tr>
          <td colspan="12">
            <details>
              <summary> View satisfaction breakdown by facility area</summary>
              <table style="margin-top:1rem; width:100%;">
                <thead>
                  <tr>
                    <th style="width:40%;">Facility Area</th>
                    <th style="width:20%;">Good Mentions</th>
                    <th style="width:20%;">Bad Mentions</th>
                    <th style="width:20%;">Net Score</th>
                  </tr>
                </thead>
                <tbody>
                  <% m.areaSatisfaction.forEach(row => { %>
                    <tr style="<%= row.net_score < 0 ? 'background-color:#ffe5e5;' : '' %>">
                      <td>
                        <%= row.area %>
                        <%= row.net_score < 0 ? '⚠️' : row.net_score > 0 ? '✅' : '' %>
                      </td>
                      <td><%= row.good_count %></td>
                      <td><%= row.bad_count %></td>
                      <td style="font-weight: bold; color: <%= row.net_score >= 0 ? 'green' : 'red' %>;">
                        <%= row.net_score %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </details>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p><em>No facilities match those filters.</em></p>
  <% } %>
</body>
</html>
