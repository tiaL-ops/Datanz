<!DOCTYPE html>
<html lang="<%= currentLang %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Search</title>
  <link rel="stylesheet" href="/styles/government.css"> 
  <style>
    /* RESET BROWSER DEFAULT STYLES */
    form {
      all: unset;
      box-sizing: border-box;
    }
  
    /* BASE FORM STYLING */
    form {
      display: grid;
      gap: 1rem;
      padding: 1rem 0;
    }
  
    label {
      font-weight: bold;
      font-size: 14px;
    }
  
    select, input[type="date"], input[type="range"] {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
      width:120px;
      text-align:center;
    }
  
    .filter-group select {
  width: 160px; /* or 100% if you want full width */
  margin: 0; /* ensure no extra margin is causing the gap */
  font-size:14px;
  
}
    .range-value {
      font-weight: bold;
    }
  
    .switch {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header class="top-nav">
    <div class="logo"><a href="/?lang=<%= currentLang %>" id="datanzLink"><%= __('site_name') %></a></div>
    <ul class="nav-links">
      <div class="dropdown">
        <li class="dropbtn"><%= __('menu') %></li>
        <div class="dropdown-content">
          <a href="/government?lang=<%= currentLang %>"><%= __('home') %></a>
          <a href="/government/worst?lang=<%= currentLang %>"><%= __('worst_facilities') %></a>
          <a href="/government/advanced-search?lang=<%= currentLang %>"><%= __('advanced_search') %></a>
        </div>
      </div>
      <li><a href="/auth/logout?lang=<%= currentLang %>"><%= __('sign_out') %></a></li>
    </ul>
    <div class="language-switcher" style="margin-right: 20px;">
      <% const targetLang = currentLang === 'en' ? 'sw' : 'en'; %>
      <a href="?lang=<%= targetLang %>">
        <button>
          <%= targetLang === 'sw' ? 'üá∞üá™ Swahili' : 'üá¨üáß English' %>
        </button>
      </a>
    </div>
  </header>
  <main>
    <h2 style = "margin-top: 30px;">Welcome to the Advanced Search page.</h2>
    
        <h3 style="grid-column: span 2; color: #6B7280;">
          Use the filters below to guide you to the facilities that need the most help.
        </h3>
    <form method="get">
      <div class = "filter-group">
          <label for="region">Region</label>
          <select id="region" name="region">
            <option value="" >Any</option>
            <option value="Arusha"      <%= filters.region==='Arusha'      ? 'selected' : '' %>>Arusha</option>
            <option value="Kilimanjaro" <%= filters.region==='Kilimanjaro' ? 'selected' : '' %>>Kilimanjaro</option>
            <option value="Tanga"       <%= filters.region==='Tanga'       ? 'selected' : '' %>>Tanga</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="bestCategory">Highlight the best facilities in this criterion:</label>
          <select id="bestCategory" name="bestCategory">
            <option value="">- Select Option -</option>
            <% areas.forEach(area => { %>
              <option value="<%= area %>" <%= filters.bestCategory===area ? 'selected' : '' %>><%= area %></option>
            <% }) %>
          </select>
        </div>

        <div class="filter-group">
          <label for="startDate">Start Date</label>
          <input
            id="startDate"
            name="startDate"
            type="date"
            value="<%= filters.startDate || '' %>"
          >
        </div>
        
        <div class="filter-group">
          <label for="endDate">End Date</label>
          <input
            id="endDate"
            name="endDate"
            type="date"
            value="<%= filters.endDate || '' %>"
          >
        </div>
        
    
        <div class="filter-group">
          <label for="waitThreshold">
            Show facilities where average wait is more than
            <span class="range-value" id="waitVal"><%= filters.waitThreshold||0 %></span> minutes
          </label>
          <input
            id="waitThreshold"
            name="waitThreshold"
            type="range"
            min="0" max="300"
            value="<%= filters.waitThreshold||0 %>"
            oninput="waitVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="satThreshold">
            Only show facilities where satisfaction is below
            <span class="range-value" id="satVal"><%= filters.satThreshold||5 %></span> out of 5
          </label>
          <input
            id="satThreshold"
            name="satThreshold"
            type="range"
            min="1" max="5"
            value="<%= filters.satThreshold||5 %>"
            oninput="satVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="confiThreshold">
            Facilities with confidentiality concerns in
            <span class="range-value" id="confVal"><%= filters.confiThreshold||0 %></span>% or more of visits
          </label>
          <input
            id="confiThreshold"
            name="confiThreshold"
            type="range"
            min="0" max="100"
            value="<%= filters.confiThreshold||0 %>"
            oninput="confVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="permThreshold">
            Show facilities where permission was not respected in
            <span class="range-value" id="permVal"><%= filters.permThreshold||0 %></span>% or more of visits
          </label>
          <input
            id="permThreshold"
            name="permThreshold"
            type="range"
            min="0" max="100"
            value="<%= filters.permThreshold||0 %>"
            oninput="permVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="testThreshold">
            Highlight where
            <span class="range-value" id="testVal"><%= filters.testThreshold||0 %></span>% or more visits had missing tests
          </label>
          <input
            id="testThreshold"
            name="testThreshold"
            type="range"
            min="0" max="100"
            value="<%= filters.testThreshold||0 %>"
            oninput="testVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="medThreshold">
            Facilities where patients missed medications in
            <span class="range-value" id="medVal"><%= filters.medThreshold||0 %></span>% or more visits
          </label>
          <input
            id="medThreshold"
            name="medThreshold"
            type="range"
            min="0" max="100"
            value="<%= filters.medThreshold||0 %>"
            oninput="medVal.textContent = this.value"
          >
        </div>
    
        <div class="filter-group">
          <label for="paymentMode">Prefer facilities where most patients pay with:</label>
          <select id="paymentMode" name="paymentMode">
            <option value="">Any</option>
            <option value="Cash"      <%= filters.paymentMode==='Cash'      ? 'selected' : '' %>>Cash</option>
            <option value="Insurance" <%= filters.paymentMode==='Insurance' ? 'selected' : '' %>>Insurance</option>
            <option value="Free"      <%= filters.paymentMode==='Free'      ? 'selected' : '' %>>Free</option>
          </select>
        </div>
   
        <button type="submit" style = "margin-right: 30px">Apply Filters</button>
      </form>
      
      <br>
      <p style="color: #6B7280; text-align: left; margin-left:30px;">
        Use the toggle below to switch between the table and map view.
      </p>
      <label class="switch">
        <input type="checkbox" id="myToggle">
        <span class="slider round"></span>
      </label>
      <% if (bestBy) { %>
        <section>
          <h2>Best facility for ‚Äú<%= bestBy.area %>‚Äù</h2>
          <p>
            <strong><%= bestBy.best.facility_name %></strong>
            (Code: <%= bestBy.best.facility_code %>)<br>
    
          </p>
        </section>
      <% } %>
    
      <div style = "margin-left: 30px; margin-right:30px">
      <% if (results && results.length) { %>
    <form method="get">
      <h2><%= __('refine_search') %></h2>

      <p style="grid-column: span 2; font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">
        <%= __('refine_search_description') %>
      </p>

      <div class="filter-group">
        <label for="region"><%= __('region_label') %></label>
        <select id="region" name="region">
          <option value=""><%= __('any') %></option>
          <option value="Arusha" <%= filters.region==='Arusha' ? 'selected' : '' %>><%= __('region_arusha') %></option>
          <option value="Kilimanjaro" <%= filters.region==='Kilimanjaro' ? 'selected' : '' %>><%= __('region_kilimanjaro') %></option>
          <option value="Tanga" <%= filters.region==='Tanga' ? 'selected' : '' %>><%= __('region_tanga') %></option>
        </select>
      </div>
      <div class="filter-group">
        <label for="startDate"><%= __('start_date') %></label>
        <input id="startDate" name="startDate" type="date" value="<%= filters.startDate || '' %>">
      </div>
      <div class="filter-group">
        <label for="endDate"><%= __('end_date') %></label>
        <input id="endDate" name="endDate" type="date" value="<%= filters.endDate || '' %>">
      </div>
      <div class="filter-group">
        <label for="waitThreshold">
          <%= __('filter_wait_above') %> <span class="range-value" id="waitVal"><%= filters.waitThreshold||0 %></span> <%= __('minutes') %>
        </label>
        <input id="waitThreshold" name="waitThreshold" type="range" min="0" max="300" value="<%= filters.waitThreshold||0 %>" oninput="waitVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="satThreshold">
          <%= __('filter_sat_below') %> <span class="range-value" id="satVal"><%= filters.satThreshold||5 %></span> <%= __('out_of_5') %>
        </label>
        <input id="satThreshold" name="satThreshold" type="range" min="1" max="5" value="<%= filters.satThreshold||5 %>" oninput="satVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="confiThreshold">
          <%= __('filter_confidentiality') %> <span class="range-value" id="confVal"><%= filters.confiThreshold||0 %></span>%
        </label>
        <input id="confiThreshold" name="confiThreshold" type="range" min="0" max="100" value="<%= filters.confiThreshold||0 %>" oninput="confVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="permThreshold">
          <%= __('filter_permission') %> <span class="range-value" id="permVal"><%= filters.permThreshold||0 %></span>%
        </label>
        <input id="permThreshold" name="permThreshold" type="range" min="0" max="100" value="<%= filters.permThreshold||0 %>" oninput="permVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="testThreshold">
          <%= __('filter_tests_missing') %> <span class="range-value" id="testVal"><%= filters.testThreshold||0 %></span>%
        </label>
        <input id="testThreshold" name="testThreshold" type="range" min="0" max="100" value="<%= filters.testThreshold||0 %>" oninput="testVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="medThreshold">
          <%= __('filter_meds_missing') %> <span class="range-value" id="medVal"><%= filters.medThreshold||0 %></span>%
        </label>
        <input id="medThreshold" name="medThreshold" type="range" min="0" max="100" value="<%= filters.medThreshold||0 %>" oninput="medVal.textContent = this.value">
      </div>
      <div class="filter-group">
        <label for="paymentMode"><%= __('filter_payment_mode') %></label>
        <select id="paymentMode" name="paymentMode">
          <option value=""><%= __('any') %></option>
          <option value="Cash" <%= filters.paymentMode==='Cash' ? 'selected' : '' %>><%= __('cash') %></option>
          <option value="Insurance" <%= filters.paymentMode==='Insurance' ? 'selected' : '' %>><%= __('insurance') %></option>
          <option value="Free" <%= filters.paymentMode==='Free' ? 'selected' : '' %>><%= __('free') %></option>
        </select>
      </div>
      <div class="filter-group">
        <label for="bestCategory"><%= __('filter_best_area') %></label>
        <select id="bestCategory" name="bestCategory">
          <option value=""><%= __('none') %></option>
          <% areas.forEach(area => { %>
            <option value="<%= area %>" <%= filters.bestCategory===area ? 'selected' : '' %>><%= area %></option>
          <% }) %>
        </select>
      </div>
      <button type="submit"><%= __('apply_filters') %></button>
    </form>
    <br>
    <label class="switch">
      <input type="checkbox" id="myToggle">
      <span class="slider round"></span>
    </label>
    <% if (bestBy) { %>
      <section>
        <h2><%= __('best_facility_for') %> ‚Äú<%= bestBy.area %>‚Äù</h2>
        <p><strong><%= bestBy.best.facility_name %></strong> (<%= __('code') %>: <%= bestBy.best.facility_code %>)</p>
      </section>
    <% } %>
    <% if (results && results.length) { %>
      <table>
        <caption><%= __('matching_facilities') %>: <%= results.length %></caption>
        <thead>
          <tr>
            <th><%= __('modal_headers.name') %></th><th><%= __('modal_headers.code') %></th><th><%= __('modal_headers.location') %></th><th><%= __('modal_headers.avg_wait') %></th>
            <th><%= __('modal_headers.avg_sat') %></th><th><%= __('modal_headers.no_privacy') %></th><th><%= __('modal_headers.no_permission') %></th>
            <th><%= __('modal_headers.missed_tests') %></th><th><%= __('modal_headers.missed_meds') %></th><th><%= __('modal_headers.top_payment') %></th>
            <th><%= __('modal_headers.top_problems') %></th><th><%= __('modal_headers.top_positives') %></th>
          </tr>
        </thead>
        <tbody>
          <% results.forEach(fac => {
               const m = fac.metrics;
          %>
          <tr>
            <td><%= fac.name %></td>
            <td><%= fac.facility_code %></td>
            <td><%= fac.location %></td>
            <td><%= m.avgWait.toFixed(1) %>&nbsp;<%= __('minutes') %></td>
            <td><%= m.avgSat %></td>
            <td><%= (100 - m.yesConfi).toFixed(0) %>%</td>
            <td><%= (100 - m.yesPerm).toFixed(0) %>%</td>
            <td><%= (100 - m.yesTests).toFixed(0) %>%</td>
            <td><%= (100 - m.yesMeds).toFixed(0) %>%</td>
            <td><%= m.topPayMode %></td>
            <td><%= m.topProblems.slice(0,3).join(", ") %></td>
            <td><%= m.topPositives.slice(0,3).join(", ") %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <p><em><%= __('no_matching_facilities') %></em></p>
    <% } %>
    <br>
    <div id="facilityModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="closeFacilityPopup()">&times;</span>
        <h2 id="modalFacilityName"></h2>
        <table>
          <thead>
            <tr>
              <th><%= __('modal_headers.name') %></th><th><%= __('modal_headers.code') %></th><th><%= __('modal_headers.location') %></th><th><%= __('modal_headers.avg_wait') %></th>
              <th><%= __('modal_headers.avg_sat') %></th><th><%= __('modal_headers.no_privacy') %></th><th><%= __('modal_headers.no_permission') %></th>
              <th><%= __('modal_headers.missed_tests') %></th><th><%= __('modal_headers.missed_meds') %></th><th><%= __('modal_headers.top_payment') %></th>
              <th><%= __('modal_headers.top_problems') %></th><th><%= __('modal_headers.top_positives') %></th>
            </tr>
          </thead>
          <tbody id="modalFacilityDetails">
            <!-- Dynamic content -->
          </tbody>
        </table>
      <% } else { %>
        <p><em>No facilities match those filters.</em></p>
      <% } %>
      </div>
    <br>
      <div id="facilityModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close-button" onclick="closeFacilityPopup()">&times;</span>
          <h2 id="modalFacilityName"></h2>
          <table>
            <thead>
              <tr>
                <th>Name</th><th>Code</th><th>Location</th><th>Avg Wait</th>
                <th>Avg Sat</th><th>% No Privacy</th><th>% No Permission</th>
                <th>% Missed Tests</th><th>% Missed Meds</th><th>Top Payment</th>
                <th>Top Problems</th><th>Top Positives</th>
              </tr>
            </thead>
            <tbody id="modalFacilityDetails">
              <!-- Dynamic content -->
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </div>
  </main>
  <div id="map" style = "margin-left:30px; width: 1405px "></div>
<br>
  <section class="back-link">
    <div style="text-align: center;">
      <a href="/government">‚Üê Back to government dashboard</a>
    </div>
        </section>
  <br>

  <script src="/js/government.js"></script>
  <script>
    const checkbox = document.getElementById('myToggle');
    const table = document.querySelector('table');

    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        table.style.display = 'none';
        document.getElementById('map').style.display = 'block';
      } else {
        table.style.display = 'table';
        document.getElementById('map').style.display = 'none';
      }
    });

    const facilities = <%- JSON.stringify(results) %>;

    function initMap() {
      const tanzaniaCenter = { lat: -3.383545, lng:  36.689744 };  
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: tanzaniaCenter,
      });
      const market = new google.maps.Marker({
        position: tanzaniaCenter,
        map: map,
        title: "Tanzania Center",
      });
      facilities.forEach(facility => {
        const marker = new google.maps.Marker({
          position: { lat: facility.ltd, lng: facility.lng },
          map: map,
          title: facility.name
        });
        if(facility.metrics.avgWeight <= 3){
          marker.setIcon({
            url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            scaledSize: new google.maps.Size(30, 30)
          });
        } else if (facility.metrics.avgWeight <= 4) {
          marker.setIcon({
            url: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
            scaledSize: new google.maps.Size(30, 30)
          });
        } else {
          marker.setIcon({
            url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
            scaledSize: new google.maps.Size(30, 30)
          });
        }
        const infoWindow = new google.maps.InfoWindow({
          content: `<strong><a href="/facilities/${facility.facility_id}?lang=${currentLang}">${facility.name}</a></strong>`
        });
        marker.addListener("click", () => infoWindow.open(map, marker));
      });
    }
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap"></script>
</body>
</html>
