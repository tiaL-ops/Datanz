<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>District Official</title>
  <link rel="stylesheet" href="/styles/government.css">
</head>

<body>
  <h1>Welcome [should display then ame here pls someone do it i wanna slleep] </h1>

  <form method="get">
    <div>
      <label for="region">Region</label>
      <select id="region" name="region">
        <option value="">Any</option>
        <option value="Arusha" <%=filters.region==='Arusha' ? 'selected' : '' %>>Arusha</option>
        <option value="Kilimanjaro" <%=filters.region==='Kilimanjaro' ? 'selected' : '' %>>Kilimanjaro</option>
        <option value="Tanga" <%=filters.region==='Tanga' ? 'selected' : '' %>>Tanga</option>
      </select>
    </div>


    <div>
      <label for="waitThreshold">
        Long waits: avg wait &gt;
        <input id="waitThreshold" name="waitThreshold" type="number" step="1" style="width:4rem;"
          value="<%= filters.waitThreshold || '' %>"> min
      </label>
    </div>


    <div>
      <label for="satThreshold">
        Low satisfaction: avg score &lt;
        <input id="satThreshold" name="satThreshold" type="number" min="1" max="5" step="1" style="width:4rem;"
          value="<%= filters.satThreshold || '' %>"> /5
      </label>
    </div>

    <div>
      <label for="confiThreshold">
        Confidentiality: ≥
        <input id="confiThreshold" name="confiThreshold" type="number" step="1" style="width:4rem;"
          value="<%= filters.confiThreshold || '' %>">% said “No”
      </label>
    </div>


    <div>
      <label for="permThreshold">
        Permission issues: ≥
        <input id="permThreshold" name="permThreshold" type="number" step="1" style="width:4rem;"
          value="<%= filters.permThreshold || '' %>">% NOT asked
      </label>
    </div>


    <div>
      <label for="testThreshold">
        Tests missing: ≥
        <input id="testThreshold" name="testThreshold" type="number" step="1" style="width:4rem;"
          value="<%= filters.testThreshold || '' %>">% did NOT get all
      </label>
    </div>


    <div>
      <label for="medThreshold">
        Meds gap: ≥
        <input id="medThreshold" name="medThreshold" type="number" step="1" style="width:4rem;"
          value="<%= filters.medThreshold || '' %>">% some/none
      </label>
    </div>





    <div>
      <label for="paymentMode">Dominant payment type</label>
      <select id="paymentMode" name="paymentMode">
        <option value="">Any</option>
        <option value="Cash" <%=filters.paymentMode==='Cash' ? 'selected' : '' %>>Cash</option>
        <option value="Insurance" <%=filters.paymentMode==='Insurance' ? 'selected' : '' %>>Insurance</option>
        <option value="Free" <%=filters.paymentMode==='Free' ? 'selected' : '' %>>Free</option>
      </select>
    </div>


    <div>
      <label for="bestCategory">Best facility in:</label>
      <select id="bestCategory" name="bestCategory">
        <option value="">— none —</option>
        <% areas.forEach(area=> { %>
          <option value="<%= area %>" <%=filters.bestCategory===area ? 'selected' : '' %>><%= area %>
          </option>
          <% }) %>
      </select>
    </div>

    <div>
      <label for="worstCategory">Worst facility in:</label>
      <select id="worstCategory" name="worstCategory">
        <option value="">— none —</option>
        <% areas.forEach(area=> { %>
          <option value="<%= area %>" <%=filters.worstCategory===area ? 'selected' : '' %>><%= area %>
          </option>
          <% }) %>
      </select>
    </div>


    <div>
      <label for="negativeCategory">Show only facilities with any negative feedback in:</label>
      <select id="negativeCategory" name="negativeCategory">
        <option value="">— none —</option>
        <% areas.forEach(area=> { %>
          <option value="<%= area %>" <%=filters.negativeCategory===area ? 'selected' : '' %>><%= area %>
          </option>
          <% }) %>
      </select>
    </div>

    <button type="submit">Apply Filters</button>
  </form>

  <br>
  <label class="switch">
    <input type="checkbox" id="myToggle">
    <span class="slider round"></span>
  </label>

  <% if (!toggled){ %> 
  
   
  <% } else { %>
 
  <%} %>
  <% if (bestBy) { %>
    <section>
      <h2>Best facility for “<%= bestBy.area %>”</h2>
      <p>
        <strong>
          <%= bestBy.best.facility_name %>
        </strong>
        (Code: <%= bestBy.best.facility_code %>)<br>
          Mentions: <%= bestBy.best.good_count %>
      </p>
    </section>
    <% } %>


  <% if (worstBy) { %>
    <section>
      <h2>Worst facility for “<%= worstBy.area %>”</h2>
      <p>
        <strong>
          <%= worstBy.worst.facility_name %>
        </strong>
        (Code: <%= worstBy.worst.facility_code %>)<br>
          Mentions: <%= worstBy.worst.bad_count %>
      </p>
    </section>
    <% } %>


  <% if (results && results.length) { %>
    <table>
      <caption>Matching Facilities: <%= results.length %>
      </caption>
      <thead>
        <tr>
          <th>Name</th>
          <th>Code</th>
          <th>Location</th>
          <th>Avg Wait</th>
          <th>Avg Sat</th>
          <th>% No Privacy</th>
          <th>% No Permission</th>
          <th>% Missed Tests</th>
          <th>% Meds Gap</th>
          <th>Top Payment</th>
          <th>Top Problems</th>
          <th>Top Positives</th>
        </tr>
      </thead>
<tbody>
  <% results.forEach(fac=> {
    const m = fac.metrics;
    %>
    <tr>
      <td>
        <%= fac.name %>
      </td>
      <td>
        <%= fac.facility_code %>
      </td>
      <td>
        <%= fac.location %>
      </td>
      <td>
        <%= m.avgWait.toFixed(1) %> min
      </td>
      <td>
        <%= m.avgSat %>
      </td>
      <td>
        <%= (100 - m.yesConfi).toFixed(0) %>%
      </td>
      <td>
        <%= (100 - m.yesPerm).toFixed(0) %>%
      </td>
      <td>
        <%= (100 - m.yesTests).toFixed(0) %>%
      </td>
      <td>
        <%= (100 - m.yesMeds).toFixed(0) %>%
      </td>
      <td>
        <%= m.topPayMode %>
      </td>
      <td>
        <%= m.topProblems.slice(0,3).join(", ") %></td>
    <td><%= m.topPositives.slice(0,3).join(" , ") %></td>
  </tr>
  <% }) %>
</tbody>
    </table>
  <% } else { %>
    <p><em>No facilities match those filters.</em></p>
  <% } %>
<br>

<div id="map"></div>

</body>
<script>
  const checkbox = document.getElementById('myToggle');
  const table = document.querySelector('table');

  checkbox.addEventListener('change', () => {
    if (checkbox.checked) {
      table.style.display = 'none';
      document.getElementById('map').style.display = 'block';
    } else {
      table.style.display = 'table';
      document.getElementById('map').style.display = 'none';

    }
  });

  const facilities = <%- JSON.stringify(facilities) %>;

function initMap() {
  const tanzaniaCenter = { lat: -6.3690, lng: 34.8888 };
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 9,
    center: tanzaniaCenter,
  });

  facilities.forEach(facility => {
    const marker = new google.maps.Marker({
      position: { lat: facility.ltd, lng: facility.lng },
      map: map,
      title: facility.name
    });

    const infoWindow = new google.maps.InfoWindow({
      content: `<strong>${facility.name}</strong>`
    });

    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });
  });
}
</script>

  <script async
  src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap">

</script>

</html>